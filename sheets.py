import pprint
from google_sheet_client import client
from teamleaders import get_team_leaders, DEFAULT_TEAMLEADER

# –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—á–∫—É
spreadsheet_id = '1q6hf-FfKLB1seAguqS4SDTuMZnLVFLMKssVPIqPh-XA'
sheet = client.open_by_key(spreadsheet_id).worksheet('–ó–∞—è–≤–∫–∏')

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
def formatMessage(record):
    text = str(record['–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –¢–õ']) + '\n\n' + \
        '‚ÄºÔ∏è–ó–∞—è–≤–∫–∞ ‚Ññ ' + str(record['–ù–æ–º–µ—Ä –∑–∞—è–≤–∫–∏']) + '\n' + \
        '–î–ª—è –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è: ' + str(record['–£–∫–∞–∂–∏—Ç–µ –§–ò–û –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è']) + '\n' + \
        'üéì –ù–∞ —É—á–µ–Ω–∏–∫–∞ ' + str(record['–£–∫–∞–∂–∏—Ç–µ –§–ò–û —É—á–µ–Ω–∏–∫–∞ ']) + ' –∏–∑ –≥—Ä—É–ø–ø—ã ' + str(record['–ì—Ä—É–ø–ø–∞ —É—á–µ–Ω–∏–∫–∞ (—Ñ–æ—Ä–º–∞—Ç —Ü–∏—Ñ—Ä—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä, –û–Ω–ª–∞–π–Ω120_–í-10)']) + '\n' + \
        'üì± –ö–æ–Ω—Ç–∞–∫—Ç—ã: ' + str(record['–ö–æ–Ω—Ç–∞–∫—Ç—ã —É—á–µ–Ω–∏–∫–∞, —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å, –µ—Å–ª–∏ –Ω–µ –º—Å–∫. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –∏–º—è —Ä–æ–¥–∏—Ç–µ–ª—è + –∫–æ–Ω—Ç–∞–∫—Ç—ã. –ï—Å—Ç—å –ª–∏ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä, –∫–∞–∫–æ–π?']) + '\n' + \
        'üìö –ú–æ–¥—É–ª—å –∏ —É—Ä–æ–∫: ' + str(record['–ù–∞ –∫–∞–∫–æ–º –º–æ–¥—É–ª–µ –∏ –ø—Ä–æ—à–µ–¥—à–∏–π —É—Ä–æ–∫ —É —É—á–µ–Ω–∏–∫–∞ (—Ñ–æ—Ä–º–∞—Ç –ú5–£3)']) + '\n' + \
        'üìù –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ö–ú–∞: ' + str(record['–ü—Ä–∏—á–∏–Ω–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —É—Ä–æ–∫–∞']) + '\n'

    if record['–û—Ç –∫–æ–≥–æ –∑–∞—è–≤–∫–∞, —É–∫–∞–∂–∏—Ç–µ –¥–æ–ª–∂–Ω–æ—Å—Ç—å'] == '–ö—Ä–∏–∑–∏—Å-–º–µ–Ω–µ–¥–∂–µ—Ä':
        text = '‚ùó‚ùó‚ùó –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ó–ê–Ø–í–ö–ê ‚ùó‚ùó‚ùó'+'\n\n' + text
        text = text + '‚ùó–ß—Ç–æ –Ω—É–∂–Ω–æ –ø—Ä–æ—Ä–∞–±–æ—Ç–∞—Ç—å: ' + record['–ß—Ç–æ –º—ã –ø–æ–æ–±–µ—â–∞–ª–∏ (–ø–æ–ª–µ –¥–ª—è –∫—Ä–∏–∑–∏—Å-–º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤, –∫–∞–∫–∏–µ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–µ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è –æ–±–µ—â–∞–ª–∏ –ø—Ä–æ—Ä–∞–±–æ—Ç–∞—Ç—å)'] + '\n'
    if str(record['–î–æ –∫–∞–∫–æ–≥–æ —á–∏—Å–ª–∞ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Å—Ç–∏ –¥–æ–ø?']) != '':
        text = text + 'üïê–£—Ä–æ–∫ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Å—Ç–∏ –¥–æ: ' + str(record['–î–æ –∫–∞–∫–æ–≥–æ —á–∏—Å–ª–∞ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Å—Ç–∏ –¥–æ–ø?'])
    return text

def getMessages():
    # –ó–∞–±–∏—Ä–∞–µ–º –≤—Å–µ –∑–∞–ø–∏—Å–∏ –∏—Ö —Ç–∞–±–ª–∏—Ü—ã
    work = sheet.get_all_records()
    # print(work)
    # –ù–∞–π—Ç–∏ –∫–æ–Ω–µ—Ü —Ç–∞–±–ª–∏—Ü—ã –∏ –æ–±—Ä–µ–∑–∞—Ç—å –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
    endIndex = 0
    for i in range(len(work)):
        # –î–æ–±–∞–≤–∏–º –ø–æ–ª–µ '–ù–æ–º–µ—Ä –∑–∞—è–≤–∫–∏'
        work[i]['–ù–æ–º–µ—Ä –∑–∞—è–≤–∫–∏'] = str(endIndex + 2)
        endIndex += 1
        if work[i]['–£–∫–∞–∂–∏—Ç–µ –§–ò–û —É—á–µ–Ω–∏–∫–∞ '] == '':
            break
    work = work[:endIndex - 1]

    # –°–æ–∑–¥–∞–¥–∏–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏
    recordForSending = []
    # –°–æ–∑–¥–∞–¥–∏–º —Å–ø–∏—Å–æ–∫ —Å –Ω–æ–º–µ—Ä–∞–º–∏ –∑–∞—è–≤–æ–∫
    ticketsNumber = []
    # –î–æ–±–∞–≤–∏–º –≤ —ç—Ç—É —Ç–∞–±–ª–∏—Ü—É –≤—Å–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏
    for i in work:
        if i['–î–∞'] != '–î–∞':
            recordForSending.append(i)
            ticketsNumber.append(i['–ù–æ–º–µ—Ä –∑–∞—è–≤–∫–∏'])
    # –í—ã–≤–æ–¥ –∑–∞–ø–∏—Å–µ–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
    # pp = pprint.PrettyPrinter()
    # pp.pprint(recordForSending)

    # –°–æ–∑–¥–∞–¥–∏–º —Å–ª–æ–≤–∞—Ä—å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
    messages = {}
    # –î–æ–±–∞–≤–∏–º –≤ –Ω–µ–≥–æ –≤—Å–µ—Ö –¢–õ–æ–≤
    for i in get_team_leaders():
        messages[i[0]] = []

    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤—Å–µ –∑–∞–ø–∏—Å–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∏—Ö –≤ —Å–ª–æ–≤–∞—Ä—å
    for record in recordForSending:
        try:
            messages[record['–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –¢–õ']].append(formatMessage(record))
        except KeyError:
            messages[DEFAULT_TEAMLEADER[0]].append(formatMessage(record))
    return messages, ticketsNumber

def updateTableSendedTickets(tickets):
    for ticket in tickets:
        sheet.update('N' + str(ticket), '–î–∞')

def updateTableCell(cell, number, value):
    sheet.update(str(cell) + str(number), value)
